name: Build (npm Cache)

on:
  workflow_dispatch:
  push:
    branches: [main]
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.cache
          key: npm-cache-${{ inputs.DOCKER_REPOSITORY }}-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            npm-cache-${{ inputs.DOCKER_REPOSITORY }}-

      - name: Build with npm Cache (GHA)
        run: |
          start_time=$(date +%s)
          docker buildx build \
            --cache-from type=local,src=/tmp/.cache \
            --cache-to type=local,dest=/tmp/.cache,mode=max \
            -f build/cached/Dockerfile.npmcache \
            -t multistage-npm-cache \
            --load \
            .
          end_time=$(date +%s)
          echo "BUILD_TIME=$((end_time - start_time))" >> $GITHUB_ENV

      - name: Get Image Size
        run: |
          size=$(docker images multistage-npm-cache --format "{{.Size}}")
          echo "IMAGE_SIZE=$size" >> $GITHUB_ENV

      - name: Output Metrics
        run: |
          echo "=== Metrics ==="
          echo "Build Time: ${{ env.BUILD_TIME }} seconds"
          echo "Image Size: ${{ env.IMAGE_SIZE }}"

          echo "### Build Metrics :rocket:" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "| :--- | :--- |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Time | ${{ env.BUILD_TIME }} seconds |" >> $GITHUB_STEP_SUMMARY
          echo "| Image Size | ${{ env.IMAGE_SIZE }} |" >> $GITHUB_STEP_SUMMARY
